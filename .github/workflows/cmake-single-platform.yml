name: CMake Build and Test

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  BUILD_TYPE: Release
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_MAXSIZE: 2G
  CCACHE_COMPRESS: true
  CCACHE_COMPRESSLEVEL: 6
  DEBIAN_FRONTEND: noninteractive

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache Git submodules
        uses: actions/cache@v4
        with:
          path: |
            external/
            .git/modules/
          key: ${{ runner.os }}-submodules-${{ hashFiles('.gitmodules') }}
          restore-keys: |
            ${{ runner.os }}-submodules-

      - name: List extern contents
        run: ls -l external/

      - name: Benchmark - Start Time
        id: start-time
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Cache APT packages
        uses: actions/cache@v4
        id: apt-cache
        with:
          path: |
            /var/lib/apt/lists
            /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('**/workflows/*.yml') }}-${{ env.BUILD_TYPE }}
          restore-keys: |
            ${{ runner.os }}-apt-${{ hashFiles('**/workflows/*.yml') }}-
            ${{ runner.os }}-apt-

      - name: Install dependencies
        id: deps-install
        run: |
          echo "deps_start=$(date +%s)" >> $GITHUB_OUTPUT

          # Configure apt for faster downloads only
          echo 'Acquire::Retries "3";' | sudo tee -a /etc/apt/apt.conf.d/80-retries
          echo 'Acquire::http::Timeout "10";' | sudo tee -a /etc/apt/apt.conf.d/80-timeout
          echo 'Acquire::Queue-Mode "host";' | sudo tee -a /etc/apt/apt.conf.d/80-parallel

          # Only update if cache miss
          if [ "${{ steps.apt-cache.outputs.cache-hit }}" != "true" ]; then
            echo "ðŸ“¦ Cache miss - updating package lists"
            sudo apt update
          else
            echo "ðŸŽ¯ Cache hit - skipping apt update"
          fi

          # Install packages with optimized flags for speed
          sudo apt install -y --no-install-recommends --no-install-suggests \
            -o Dpkg::Options::="--force-confdef" \
            -o Dpkg::Options::="--force-confold" \
            -o APT::Install-Suggests=false \
            -o APT::Install-Recommends=false \
            libgl1-mesa-dev \
            libx11-dev \
            libglfw3-dev \
            libglm-dev \
            ccache

          echo "deps_end=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Setup ccache
        run: |
          ccache --version
          ccache --zero-stats
          ccache --max-size=2G
          ccache --set-config compression=true
          ccache --set-config compression_level=6
          ccache --set-config sloppiness=file_macro,locale,time_macros
          mkdir -p ${{ env.CCACHE_DIR }}
          echo "ðŸŽ¯ ccache configured with 2G cache, compression enabled"

      - name: Cache ccache files
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ${{ runner.os }}-ccache-${{ env.BUILD_TYPE }}-${{ hashFiles('**/CMakeLists.txt', '**/*.cpp', '**/*.hpp', '**/*.h', '**/*.c', '**/*.cc', '**/*.cxx') }}
          restore-keys: |
            ${{ runner.os }}-ccache-${{ env.BUILD_TYPE }}-
            ${{ runner.os }}-ccache-

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml', '**/setup.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Cache CMake build directory
        uses: actions/cache@v4
        with:
          path: |
            build
            ~/.cmake
          key: ${{ runner.os }}-cmake-build-${{ env.BUILD_TYPE }}-${{ hashFiles('**/CMakeLists.txt', 'cmake/**/*') }}
          restore-keys: |
            ${{ runner.os }}-cmake-build-${{ env.BUILD_TYPE }}-
            ${{ runner.os }}-cmake-build-

      - name: Configure CMake
        id: cmake-config
        run: |
          echo "config_start=$(date +%s)" >> $GITHUB_OUTPUT
          cmake -B ${{github.workspace}}/build \
            -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          echo "config_end=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Build
        id: cmake-build
        run: |
          echo "build_start=$(date +%s)" >> $GITHUB_OUTPUT
          cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}} --parallel $(nproc)
          echo "build_end=$(date +%s)" >> $GITHUB_OUTPUT

      - name: ccache statistics
        run: |
          echo "ðŸ“Š ccache Statistics:"
          ccache --show-stats

      - name: Test
        id: cmake-test
        working-directory: ${{github.workspace}}/build
        run: |
          echo "test_start=$(date +%s)" >> $GITHUB_OUTPUT
          ctest --output-on-failure -C ${{env.BUILD_TYPE}} --parallel $(nproc)
          echo "test_end=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Calculate and Report Benchmarks
        run: |
          # Calculate durations
          DEPS_DURATION=$((${{ steps.deps-install.outputs.deps_end }} - ${{ steps.deps-install.outputs.deps_start }}))
          CONFIG_DURATION=$((${{ steps.cmake-config.outputs.config_end }} - ${{ steps.cmake-config.outputs.config_start }}))
          BUILD_DURATION=$((${{ steps.cmake-build.outputs.build_end }} - ${{ steps.cmake-build.outputs.build_start }}))
          TEST_DURATION=$((${{ steps.cmake-test.outputs.test_end }} - ${{ steps.cmake-test.outputs.test_start }}))
          TOTAL_DURATION=$((${{ steps.cmake-test.outputs.test_end }} - ${{ steps.start-time.outputs.start_time }}))

          # Format durations
          DEPS_MIN=$((DEPS_DURATION / 60))
          DEPS_SEC=$((DEPS_DURATION % 60))
          CONFIG_MIN=$((CONFIG_DURATION / 60))
          CONFIG_SEC=$((CONFIG_DURATION % 60))
          BUILD_MIN=$((BUILD_DURATION / 60))
          BUILD_SEC=$((BUILD_DURATION % 60))
          TEST_MIN=$((TEST_DURATION / 60))
          TEST_SEC=$((TEST_DURATION % 60))
          TOTAL_MIN=$((TOTAL_DURATION / 60))
          TOTAL_SEC=$((TOTAL_DURATION % 60))

          # Create benchmark report
          echo "## ðŸš€ CI Pipeline Performance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Duration | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependencies | ${DEPS_MIN}m ${DEPS_SEC}s | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| CMake Configure | ${CONFIG_MIN}m ${CONFIG_SEC}s | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${BUILD_MIN}m ${BUILD_SEC}s | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${TEST_MIN}m ${TEST_SEC}s | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **${TOTAL_MIN}m ${TOTAL_SEC}s** | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ccache stats
          echo "### ðŸŽ¯ ccache Statistics" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ccache --show-stats >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Print to workflow log as well
          echo "=== PERFORMANCE REPORT ==="
          echo "Dependencies: ${DEPS_MIN}m ${DEPS_SEC}s"
          echo "CMake Configure: ${CONFIG_MIN}m ${CONFIG_SEC}s" 
          echo "Build: ${BUILD_MIN}m ${BUILD_SEC}s"
          echo "Tests: ${TEST_MIN}m ${TEST_SEC}s"
          echo "Total: ${TOTAL_MIN}m ${TOTAL_SEC}s"
          echo "=========================="
