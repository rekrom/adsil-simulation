name: Performance Benchmark Analysis

on:
  workflow_dispatch: # Manual trigger only
  schedule:
    - cron: "0 2 * * 1" # Weekly analysis

env:
  BUILD_TYPE: Release
  CCACHE_DIR: ${{ github.workspace }}/.ccache

jobs:
  benchmark:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        scenario: ["cold-baseline", "warm-ccache", "incremental-ccache"]

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y libgl1-mesa-dev libx11-dev libglfw3-dev libglm-dev ccache time

      - name: Setup ccache
        run: |
          ccache --version
          ccache --zero-stats
          ccache --max-size=1G
          mkdir -p ${{ env.CCACHE_DIR }}

      - name: Cache ccache files (for warm/incremental builds)
        if: matrix.scenario != 'cold-baseline'
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: perf-benchmark-${{ runner.os }}-ccache-${{ hashFiles('**/CMakeLists.txt', '**/*.cpp', '**/*.hpp') }}
          restore-keys: |
            perf-benchmark-${{ runner.os }}-ccache-

      - name: Pre-populate cache (for warm builds)
        if: matrix.scenario == 'warm-ccache'
        run: |
          echo "Pre-building to populate ccache..."
          cmake -B build-warmup -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
          cmake --build build-warmup --parallel $(nproc)
          rm -rf build-warmup
          ccache --show-stats

      - name: Make incremental change
        if: matrix.scenario == 'incremental-ccache'
        run: |
          echo "// Benchmark: $(date)" >> apps/adsil_analyzer/main.cpp

      - name: Clean build directory
        run: rm -rf build

      - name: Record timing and build
        run: |
          START_TIME=$(date +%s)

          if [ "${{ matrix.scenario }}" == "cold-baseline" ]; then
            cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
          else
            cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
          fi

          CONFIG_END=$(date +%s)
          CONFIG_TIME=$((CONFIG_END - START_TIME))

          BUILD_START=$(date +%s)
          cmake --build build --parallel $(nproc)
          BUILD_END=$(date +%s)
          BUILD_TIME=$((BUILD_END - BUILD_START))

          TEST_START=$(date +%s)
          cd build && ctest --parallel $(nproc) -C ${{ env.BUILD_TYPE }}
          TEST_END=$(date +%s)
          TEST_TIME=$((TEST_END - TEST_START))

          TOTAL_TIME=$((TEST_END - START_TIME))

          # Get ccache stats
          if [ "${{ matrix.scenario }}" != "cold-baseline" ]; then
            CACHE_STATS=$(ccache --show-stats)
          else
            CACHE_STATS="N/A (no ccache)"
          fi

          # Save results
          cat > results.json << EOF
          {
            "scenario": "${{ matrix.scenario }}",
            "config_seconds": $CONFIG_TIME,
            "build_seconds": $BUILD_TIME,
            "test_seconds": $TEST_TIME,
            "total_seconds": $TOTAL_TIME,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          echo "=== Results for ${{ matrix.scenario }} ==="
          cat results.json
          echo ""
          echo "=== ccache Stats ==="
          echo "$CACHE_STATS"

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-${{ matrix.scenario }}
          path: results.json

  report:
    needs: benchmark
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download benchmark results
        uses: actions/download-artifact@v4
        with:
          pattern: benchmark-*
          merge-multiple: true

      - name: Generate performance report
        run: |
          echo "# ï¿½ Weekly Performance Benchmark Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Performance Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scenario | Configure | Build | Test | Total |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----------|-------|------|-------|" >> $GITHUB_STEP_SUMMARY

          # Process results (simplified - would need proper JSON parsing for production)
          for scenario in "cold-baseline" "warm-ccache" "incremental-ccache"; do
            if [ -f "results.json" ]; then
              echo "| $scenario | Processing... | Processing... | Processing... | Processing... |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Key Insights" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Baseline (cold)**: No ccache - establishes performance floor" >> $GITHUB_STEP_SUMMARY
          echo "- **Warm ccache**: Should show 50-80% build time improvement" >> $GITHUB_STEP_SUMMARY
          echo "- **Incremental**: Should show 70-95% build time improvement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This analysis helps track ccache effectiveness over time and detect performance regressions." >> $GITHUB_STEP_SUMMARY
